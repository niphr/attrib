<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to Attrib • attrib</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Attrib">
<script data-goatcounter="https://csidsno.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://www.csids.no" class="external-link"><img src="https://www.csids.no/resources/logo/logo_full_white.svg" id="csidslogo"></a>
    <a class="navbar-brand me-2" href="../index.html">attrib</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2025.8.20</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/attrib.html">Get started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/nowcast.html">Nowcasting with Attrib</a></li>
    <li><a class="dropdown-item" href="../articles/statistical_properties.html">Statistical properties used in Attrib</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://www.csids.no/">Home</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-packages">
<li><a class="external-link dropdown-item" href="https://www.csids.no/packages.html">Introduction</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Analysis planning</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/org/">org</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/plnr/">plnr</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/cs9/">cs9</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Helper functions</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csdb/">csdb</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csstyle/">csstyle</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/cstidy/">cstidy</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/cstime/">cstime</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csutil/">csutil</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Surveillance</h6></li>
    <li><a class="dropdown-item" href="https://www.csids.no/attrib/">attrib</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csalert/">csalert</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Structural data</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csdata/">csdata</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/csmaps/">csmaps</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-about" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">About</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-about">
<li><a class="external-link dropdown-item" href="https://www.csids.no/about.html">About CSIDS</a></li>
    <li><a class="external-link dropdown-item" href="https://www.csids.no/get_involved.html">Get involved</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/csids/attrib/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="attrib_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to Attrib</h1>
                        <h4 data-toc-skip class="author">Aurora Christine Hofman</h4>
            
            <h4 data-toc-skip class="date">2020-07-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/csids/attrib/blob/HEAD/vignettes/attrib.Rmd" class="external-link"><code>vignettes/attrib.Rmd</code></a></small>
      <div class="d-none name"><code>attrib.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.csids.no/attrib/">attrib</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; attrib 2025.8.20</span></span>
<span><span class="co">#&gt; https://www.csids.no/attrib/</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>attrib</code> provides a way of estimating what the mortality would have been if some given exposures are set to a reference value. By using simulations from the posterior distribution of all coefficients we can easily aggregate over time and locations while still estimating valid credible intervals.</p>
<p>This vignette will go through:</p>
<ul>
<li>how to use <code>fit_attrib</code> to fit the model to the data</li>
<li>how to use <code>est_attrib</code> to estimate the mortality under different scenarios (i.e. when the exposures are at reference values and at observed values)</li>
<li>some examples of usages of the resulting dataset</li>
</ul>
<div class="section level3">
<h3 id="data-example">Data example<a class="anchor" aria-label="anchor" href="#data-example"></a>
</h3>
<p>We will use the datasets <code>data_fake_attrib_county</code> and <code>data_fake_attrib_nation</code>.</p>
<p><code>data_fake_attrib_county</code> consists of fake mortality data for all counties of Norway on a weekly basis from 2010 until 2020. The dataset consists of the following features:</p>
<ul>
<li>location_code: Location code of the different counties</li>
<li>isoyear: Isoyear</li>
<li>isoweek: Week number</li>
<li>isoyearweek: Isoyear and isoweek</li>
<li>season: Years of the season</li>
<li>seasonweek: Number of weeks from the start of the season</li>
<li>pop_jan1_n: Population size</li>
<li>ili_isoweekmean0_6_pr100: Percentage of doctors consultations diagnosed with influenza like illnesses</li>
<li>ili_isoweekmean7_13_pr100: ili_isoweekmean0_6_pr100 lagged with one week</li>
<li>heatwavedays_n: number of heatwaves</li>
<li>deaths_n: number of deaths</li>
</ul>
<p><code>data_fake_attrib_nation</code> is a similar dataset at the national level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_fake_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_attrib_county.html">data_fake_attrib_county</a></span></span>
<span><span class="va">data_fake_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_attrib_nation.html">data_fake_attrib_nation</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_fake_county</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;location_code, isoweek&gt;</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                     &lt;num&gt;          &lt;num&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:                0.9231202                 0.8146507              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                 1.7890927              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                 1.6017501              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                 0.7167721              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                 1.1638354              0      115</span></span></code></pre></div>
<p>In this example we will look at the exposures <code>ili_isoweekmean7_13_pr100</code> and <code>heatwavedays_n</code> and calculate the attributable mortality due to these exposures.</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-using-fit_attrib">Fitting using fit_attrib<a class="anchor" aria-label="anchor" href="#fitting-using-fit_attrib"></a>
</h2>
<div class="section level3">
<h3 id="county-level">County level<a class="anchor" aria-label="anchor" href="#county-level"></a>
</h3>
<p>We want to estimate the attributable mortality due to ILI and heatwaves. <code>attrib</code> lets us fit models with both fixed and random effect and offsets using linear mixed models (LMM).</p>
<p>We use the <code>glmer</code> function from the <code>lme4</code> package. In practice, this means we must specify the response, offsets, the fixed effects, and the random effects. In our case we will model the response <em>deaths</em> as a function of:</p>
<ul>
<li>the fixed effects:
<ul>
<li>heatwavedays_n</li>
<li>ili_isoweekmean7_13_pr100</li>
<li>sin(2 * pi * (isoweek - 1) / 52)</li>
<li>cos(2 * pi * (isoweek - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(1|location_code)</li>
<li>(ili_isoweekmean7_13_pr100|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop_jan1_n)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#response</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"deaths_n"</span></span>
<span></span>
<span><span class="co"># fixed effects</span></span>
<span><span class="va">fixef_county</span> <span class="op">&lt;-</span> <span class="st">" heatwavedays_n +</span></span>
<span><span class="st">  ili_isoweekmean7_13_pr100 +</span></span>
<span><span class="st">  sin(2 * pi * (isoweek - 1) / 52) +</span></span>
<span><span class="st">  cos(2 * pi * (isoweek - 1) / 52)"</span></span>
<span></span>
<span></span>
<span><span class="co">#random effects</span></span>
<span><span class="va">ranef_county</span> <span class="op">&lt;-</span> <span class="st">"(1|location_code) +</span></span>
<span><span class="st">  (ili_isoweekmean7_13_pr100|season)"</span></span>
<span></span>
<span><span class="co">#offset</span></span>
<span><span class="va">offset_county</span> <span class="op">&lt;-</span> <span class="st">"log(pop_jan1_n)"</span></span>
<span></span>
<span><span class="co"># Now we fit the model using `fit_attrib`. </span></span>
<span><span class="va">fit_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fake_county</span>, </span>
<span>  response <span class="op">=</span> <span class="va">response</span>, </span>
<span>  fixef <span class="op">=</span> <span class="va">fixef_county</span>, </span>
<span>  ranef <span class="op">=</span> <span class="va">ranef_county</span>, </span>
<span>  offset <span class="op">=</span> <span class="va">offset_county</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This results in the following fit:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_county</span></span>
<span><span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span></span>
<span><span class="co">#&gt;   Approximation) [glmerMod]</span></span>
<span><span class="co">#&gt;  Family: poisson  ( log )</span></span>
<span><span class="co">#&gt; Formula: deaths_n ~ heatwavedays_n + ili_isoweekmean7_13_pr100 + sin(2 *  </span></span>
<span><span class="co">#&gt;     pi * (isoweek - 1)/52) + cos(2 * pi * (isoweek - 1)/52) +  </span></span>
<span><span class="co">#&gt;     offset(log(pop_jan1_n)) + (1 | location_code) + (ili_isoweekmean7_13_pr100 |  </span></span>
<span><span class="co">#&gt;     season)</span></span>
<span><span class="co">#&gt;    Data: data</span></span>
<span><span class="co">#&gt;       AIC       BIC    logLik -2*log(L)  df.resid </span></span>
<span><span class="co">#&gt;  44402.03  44462.79 -22192.02  44384.03      6305 </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups        Name                      Std.Dev. Corr </span></span>
<span><span class="co">#&gt;  location_code (Intercept)               0.001725      </span></span>
<span><span class="co">#&gt;  season        (Intercept)               0.002016      </span></span>
<span><span class="co">#&gt;                ili_isoweekmean7_13_pr100 0.005003 -1.00</span></span>
<span><span class="co">#&gt; Number of obs: 6314, groups:  location_code, 11; season, 11</span></span>
<span><span class="co">#&gt; Fixed Effects:</span></span>
<span><span class="co">#&gt;                    (Intercept)                  heatwavedays_n  </span></span>
<span><span class="co">#&gt;                       -8.79945                         0.07321  </span></span>
<span><span class="co">#&gt;      ili_isoweekmean7_13_pr100  sin(2 * pi * (isoweek - 1)/52)  </span></span>
<span><span class="co">#&gt;                        0.03429                         0.01448  </span></span>
<span><span class="co">#&gt; cos(2 * pi * (isoweek - 1)/52)  </span></span>
<span><span class="co">#&gt;                        0.06784  </span></span>
<span><span class="co">#&gt; optimizer (Nelder_Mead) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings</span></span></code></pre></div>
<p>Note that fit has the added attributes <code>offset</code> (saving the offset name) and <code>fit_fix</code> (the coefficients of the linear model fitted on only the fixed effects). These are needed by <code>est_attrib</code> to create the dataset containing only the fixed effects.</p>
</div>
<div class="section level3">
<h3 id="national-level">National level<a class="anchor" aria-label="anchor" href="#national-level"></a>
</h3>
<p>We estimate the same as before But on a national level, meaning we remove the random effect (1|location_code) since we only have one location code. This gives the following features:</p>
<ul>
<li>the fixed effects:
<ul>
<li>heatwavedays_n</li>
<li>ili_isoweekmean7_13_pr100</li>
<li>sin(2 * pi * (isoweek - 1) / 52)</li>
<li>cos(2 * pi * (isoweek - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(ili_isoweekmean7_13_pr100|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop_jan1_n)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#response</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"deaths_n"</span></span>
<span></span>
<span><span class="co"># fixed effects</span></span>
<span><span class="va">fixef_nation</span> <span class="op">&lt;-</span> <span class="st">" heatwavedays_n +</span></span>
<span><span class="st">  ili_isoweekmean7_13_pr100 +</span></span>
<span><span class="st">  sin(2 * pi * (isoweek - 1) / 52) +</span></span>
<span><span class="st">  cos(2 * pi * (isoweek - 1) / 52)"</span></span>
<span></span>
<span></span>
<span><span class="co">#random effects</span></span>
<span><span class="va">ranef_nation</span> <span class="op">&lt;-</span> <span class="st">"(ili_isoweekmean7_13_pr100|season)"</span></span>
<span></span>
<span><span class="co">#offset</span></span>
<span><span class="va">offset_nation</span> <span class="op">&lt;-</span> <span class="st">"log(pop_jan1_n)"</span></span>
<span></span>
<span><span class="co"># Now we fit the model using `fit_attrib`. </span></span>
<span><span class="va">fit_nation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fake_nation</span>, </span>
<span>  response <span class="op">=</span> <span class="va">response</span>, </span>
<span>  fixef <span class="op">=</span> <span class="va">fixef_nation</span>, </span>
<span>  ranef <span class="op">=</span> <span class="va">ranef_nation</span>, </span>
<span>  offset <span class="op">=</span> <span class="va">offset_nation</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="using-the-sim-function">Using the sim function<a class="anchor" aria-label="anchor" href="#using-the-sim-function"></a>
</h2>
<p>The <code>sim</code> function can be used to generate simulations for all the rows in our data.</p>
<p>It first generates <code>n_sim</code> simulations from the posterior distribution of the coefficients from out fit before applying these coefficients on our dataset generating <code>n_sim</code> simulations and expected mortality for each line. This is quite generic. Hence if the goal is to compute attributable mortality or incident risk ratios we use <code>est_attrib</code> as shown in a later part of the vignette.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.html">sim</a></span><span class="op">(</span><span class="va">fit_nation</span>, <span class="va">data_fake_nation</span>, <span class="va">n_sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">[</span><span class="va">id_row</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 2:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 3:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 4:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 5:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                     &lt;num&gt;          &lt;num&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 2:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 3:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 4:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 5:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt;    id_row sim_id sim_value</span></span>
<span><span class="co">#&gt;     &lt;int&gt;  &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1      1  809.0809</span></span>
<span><span class="co">#&gt; 2:      1      2  805.4690</span></span>
<span><span class="co">#&gt; 3:      1      3  809.6061</span></span>
<span><span class="co">#&gt; 4:      1      4  803.1244</span></span>
<span><span class="co">#&gt; 5:      1      5  810.9444</span></span></code></pre></div>
<p>We can see that we now have multiple expected mortalities for the same dataline. This is due to the coefficient simulations.</p>
</div>
<div class="section level2">
<h2 id="estimating-attributable-mortality-using-est_attrib">Estimating attributable mortality using est_attrib<a class="anchor" aria-label="anchor" href="#estimating-attributable-mortality-using-est_attrib"></a>
</h2>
<p>To estimate attributable mortality we simulate:</p>
<ul>
<li>the estimated mortality for observed exposures</li>
<li>the estimated mortality for the exposures set to reference values</li>
</ul>
<p>This is easily done using <code>est_attrib</code>.</p>
<p>We need to give the fit, the dataset, the exposures with reference values, and the number of simulations. <code>est_attrib</code> will then using the <code><a href="https://rdrr.io/pkg/arm/man/sim.html" class="external-link">arm::sim</a></code> function to generate simulations of the underlying posterior distribution. <code><a href="../reference/sim.html">attrib::sim</a></code> will then combine the simulated coefficients to estimate the modeled outcome (i.e. number of deaths) for each simulation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="st">"heatwavedays_n"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"ili_isoweekmean7_13_pr100"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">est_attrib_sim_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_county</span>, </span>
<span>  <span class="va">data_fake_county</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures</span>, </span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">est_attrib_sim_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_nation</span>, </span>
<span>  <span class="va">data_fake_nation</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures</span>,</span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                     &lt;num&gt;          &lt;num&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:                0.9231202                 0.8146507              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                 1.7890927              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                 1.6017501              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                 0.7167721              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                 1.1638354              0      115</span></span>
<span><span class="co">#&gt;       id sim_id sim_value_exposures=observed sim_value_heatwavedays_n=0</span></span>
<span><span class="co">#&gt;    &lt;int&gt;  &lt;num&gt;                        &lt;num&gt;                      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1      1                     113.6989                   113.6989</span></span>
<span><span class="co">#&gt; 2:     2      1                     118.5503                   118.5503</span></span>
<span><span class="co">#&gt; 3:     3      1                     118.0417                   118.0417</span></span>
<span><span class="co">#&gt; 4:     4      1                     113.4645                   113.4645</span></span>
<span><span class="co">#&gt; 5:     5      1                     116.3428                   116.3428</span></span>
<span><span class="co">#&gt;    sim_value_ili_isoweekmean7_13_pr100=0</span></span>
<span><span class="co">#&gt;                                    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                              110.5047</span></span>
<span><span class="co">#&gt; 2:                              111.6251</span></span>
<span><span class="co">#&gt; 3:                              111.3693</span></span>
<span><span class="co">#&gt; 4:                              110.8212</span></span>
<span><span class="co">#&gt; 5:                              111.0248</span></span></code></pre></div>
<p>We can see in the above dataset that the columns <em>id</em>, <em>sim_id</em>, <em>sim_value_exposures=observed</em>, <em>sim_value_heatwavedays_n=0</em>, <em>sim_value_ili_isoweekmean7_13_pr100=0</em> are added to the previous set of columns. For each row in the original dataset we now have 20 <!-- change this if we change n_sim --> rows, one for each of the simulations done by est_attrib. In each row we see the estimate of the number of deaths given a reference value for <em>sim_value_heatwavedays_n</em> and <em>sim_value_ili_isoweekmean7_13_pr100</em>.</p>
<p>To make the data processing easier later we convert the dataset from wide to long form and collapse the estimated mortality</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_county_long</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt.data.table</a></span><span class="op">(</span></span>
<span>  <span class="va">est_attrib_sim_county</span>, </span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"location_code"</span>, </span>
<span>    <span class="st">"isoyear"</span>,</span>
<span>    <span class="st">"isoweek"</span>,</span>
<span>    <span class="st">"isoyearweek"</span>,</span>
<span>    <span class="st">"season"</span>,  </span>
<span>    <span class="st">"seasonweek"</span>, </span>
<span>    <span class="st">"id"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"deaths_n"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"sim_value_heatwavedays_n=0"</span>, </span>
<span>    <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek    id sim_id</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt; &lt;int&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     1      1</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     2      1</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     3      1</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     4      1</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     5      1</span></span>
<span><span class="co">#&gt;    deaths_n sim_value_exposures=observed                       attr    value</span></span>
<span><span class="co">#&gt;       &lt;int&gt;                        &lt;num&gt;                     &lt;fctr&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      112                     113.6989 sim_value_heatwavedays_n=0 113.6989</span></span>
<span><span class="co">#&gt; 2:      113                     118.5503 sim_value_heatwavedays_n=0 118.5503</span></span>
<span><span class="co">#&gt; 3:      128                     118.0417 sim_value_heatwavedays_n=0 118.0417</span></span>
<span><span class="co">#&gt; 4:      126                     113.4645 sim_value_heatwavedays_n=0 113.4645</span></span>
<span><span class="co">#&gt; 5:      115                     116.3428 sim_value_heatwavedays_n=0 116.3428</span></span></code></pre></div>
<p>We can see that the columns <em>sim_value_heatwavedays_n=0</em>, <em>sim_value_ili_isoweekmean7_13_pr100=0</em> are now collapsed into the new column <em>attr</em> and <em>value</em> with <em>attr</em> describing which exposure we have and <em>value</em> giving the corresponding reference value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_nation_long</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt.data.table</a></span><span class="op">(</span></span>
<span>  <span class="va">est_attrib_sim_nation</span>, </span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"location_code"</span>, </span>
<span>    <span class="st">"isoyear"</span>,</span>
<span>    <span class="st">"isoweek"</span>,</span>
<span>    <span class="st">"isoyearweek"</span>,</span>
<span>    <span class="st">"season"</span>,  </span>
<span>    <span class="st">"seasonweek"</span>, </span>
<span>    <span class="st">"id"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"deaths_n"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"sim_value_heatwavedays_n=0"</span>, </span>
<span>    <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">est_attrib_nation_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_nation_long</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek    id sim_id</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt; &lt;int&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    nation_nor    2009      30     2009-30 2009/2010          1     1      1</span></span>
<span><span class="co">#&gt; 2:    nation_nor    2009      31     2009-31 2009/2010          2     2      1</span></span>
<span><span class="co">#&gt; 3:    nation_nor    2009      32     2009-32 2009/2010          3     3      1</span></span>
<span><span class="co">#&gt; 4:    nation_nor    2009      33     2009-33 2009/2010          4     4      1</span></span>
<span><span class="co">#&gt; 5:    nation_nor    2009      34     2009-34 2009/2010          5     5      1</span></span>
<span><span class="co">#&gt;    deaths_n sim_value_exposures=observed                       attr    value</span></span>
<span><span class="co">#&gt;       &lt;int&gt;                        &lt;num&gt;                     &lt;fctr&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      827                     804.4744 sim_value_heatwavedays_n=0 758.0887</span></span>
<span><span class="co">#&gt; 2:      751                     790.3920 sim_value_heatwavedays_n=0 759.7097</span></span>
<span><span class="co">#&gt; 3:      811                     782.3847 sim_value_heatwavedays_n=0 762.0038</span></span>
<span><span class="co">#&gt; 4:      787                     795.8370 sim_value_heatwavedays_n=0 764.9434</span></span>
<span><span class="co">#&gt; 5:      828                     789.0473 sim_value_heatwavedays_n=0 768.4929</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compare-the-national-data-to-data-aggregated-from-county-to-national-level-">Compare the national data to data aggregated from county to national level.<a class="anchor" aria-label="anchor" href="#compare-the-national-data-to-data-aggregated-from-county-to-national-level-"></a>
</h2>
<p>We will now aggregate our two simulated datasets (one on a county level and one on a national level) to aid in comparison.</p>
<div class="section level3">
<h3 id="aggregate-from-countyweekly-to-nationalseasonal">Aggregate from county/weekly to national/seasonal<a class="anchor" aria-label="anchor" href="#aggregate-from-countyweekly-to-nationalseasonal"></a>
</h3>
<p>We proceed by aggregating the county dataset to the national/seasonal level. Afterwards we calculate the expected attributable mortality, <code>exp_attr</code>, by subtracting <code>value</code> (the simulated expected number of deaths given the reference value of the exposure) from <em>the sim_value_exposures=observed</em>.</p>
<p>To be able to separate this dataset from the other we add a tag.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Add exp_attr, exp_irr and a tag.</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated_from_county"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, attr, sim_id&gt;</span></span>
<span><span class="co">#&gt;       season                       attr sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt;       &lt;char&gt;                     &lt;fctr&gt;  &lt;num&gt;                        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010 sim_value_heatwavedays_n=0      1                     43676.75</span></span>
<span><span class="co">#&gt; 2: 2009/2010 sim_value_heatwavedays_n=0      2                     43612.13</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_heatwavedays_n=0      3                     44387.98</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_heatwavedays_n=0      4                     44109.86</span></span>
<span><span class="co">#&gt; 5: 2009/2010 sim_value_heatwavedays_n=0      5                     44261.88</span></span>
<span><span class="co">#&gt;       value deaths_n exp_attr                    tag</span></span>
<span><span class="co">#&gt;       &lt;num&gt;    &lt;int&gt;    &lt;num&gt;                 &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 43258.31    44006 418.4357 aggregated_from_county</span></span>
<span><span class="co">#&gt; 2: 43231.69    44006 380.4454 aggregated_from_county</span></span>
<span><span class="co">#&gt; 3: 43987.75    44006 400.2311 aggregated_from_county</span></span>
<span><span class="co">#&gt; 4: 43704.35    44006 405.5112 aggregated_from_county</span></span>
<span><span class="co">#&gt; 5: 43842.15    44006 419.7335 aggregated_from_county</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregating-the-national-model-per-season">Aggregating the national model per season<a class="anchor" aria-label="anchor" href="#aggregating-the-national-model-per-season"></a>
</h3>
<p>For the national model we aggregate over seasons and create exp_attr in the same way as above.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_nation_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">tag</span><span class="op">:=</span> <span class="st">"nation"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_nation</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, attr, sim_id&gt;</span></span>
<span><span class="co">#&gt;       season                       attr sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt;       &lt;char&gt;                     &lt;fctr&gt;  &lt;num&gt;                        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010 sim_value_heatwavedays_n=0      1                     44097.56</span></span>
<span><span class="co">#&gt; 2: 2009/2010 sim_value_heatwavedays_n=0      2                     44353.71</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_heatwavedays_n=0      3                     43916.50</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_heatwavedays_n=0      4                     44384.23</span></span>
<span><span class="co">#&gt; 5: 2009/2010 sim_value_heatwavedays_n=0      5                     44122.85</span></span>
<span><span class="co">#&gt;       value deaths_n exp_attr    tag</span></span>
<span><span class="co">#&gt;       &lt;num&gt;    &lt;int&gt;    &lt;num&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 43692.75    44006 404.8075 nation</span></span>
<span><span class="co">#&gt; 2: 43936.16    44006 417.5490 nation</span></span>
<span><span class="co">#&gt; 3: 43387.22    44006 529.2817 nation</span></span>
<span><span class="co">#&gt; 4: 43940.60    44006 443.6273 nation</span></span>
<span><span class="co">#&gt; 5: 43612.60    44006 510.2482 nation</span></span></code></pre></div>
<p>For simplicity we <code><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">data.table::rbindlist</a></code> the two datasets together.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">data_national</span><span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">aggregated_nation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculate-simulation-quantiles-">Calculate simulation quantiles.<a class="anchor" aria-label="anchor" href="#calculate-simulation-quantiles-"></a>
</h3>
<p>The next thing to do is to aggregate away the simulations. The benefits of having the simulations is the possibility it gives to efficiently compute all desired quantiles. For this example we will use the .05, .5 and .95 quantiles.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quantile functins</span></span>
<span><span class="va">q025</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">q975</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We compute the quantiles for <em>exp_attr</em> in the following way.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span></span>
<span>  <span class="va">data_national</span>, </span>
<span>  <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"exp_attr"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span>, </span>
<span>    <span class="st">"value"</span>, </span>
<span>    <span class="st">"deaths_n"</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_sim_seasonal_data_national</span><span class="op">&lt;-</span> <span class="va">data_national</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span></span>
<span>    recursive <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_sim_seasonal_data_national</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, attr, tag&gt;</span></span>
<span><span class="co">#&gt;       season                                  attr                    tag</span></span>
<span><span class="co">#&gt;       &lt;char&gt;                                &lt;fctr&gt;                 &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010            sim_value_heatwavedays_n=0 aggregated_from_county</span></span>
<span><span class="co">#&gt; 2: 2009/2010            sim_value_heatwavedays_n=0                 nation</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_ili_isoweekmean7_13_pr100=0 aggregated_from_county</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_ili_isoweekmean7_13_pr100=0                 nation</span></span>
<span><span class="co">#&gt; 5: 2010/2011            sim_value_heatwavedays_n=0 aggregated_from_county</span></span>
<span><span class="co">#&gt;    median.exp_attr q025.exp_attr q975.exp_attr</span></span>
<span><span class="co">#&gt;              &lt;num&gt;         &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        410.0585      381.3500      439.3076</span></span>
<span><span class="co">#&gt; 2:        478.4722      383.9962      540.1394</span></span>
<span><span class="co">#&gt; 3:        710.3682      571.3951      900.5934</span></span>
<span><span class="co">#&gt; 4:        728.5016      483.1989      878.9887</span></span>
<span><span class="co">#&gt; 5:        461.0716      430.4962      492.7037</span></span></code></pre></div>
<p>We can now see that we have credible intervals and estimates for attributable deaths for all exposures.</p>
</div>
<div class="section level3">
<h3 id="plot-to-compare-the-national-with-the-aggregated-county-to-national-model">Plot to compare the national with the aggregated county to national model<a class="anchor" aria-label="anchor" href="#plot-to-compare-the-national-with-the-aggregated-county-to-national-model"></a>
</h3>
<p>To be able to compare the two models we make a point range plot using ggplot2.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">aggregated_sim_seasonal_data_national</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, group <span class="op">=</span> <span class="va">tag</span>, color <span class="op">=</span> <span class="va">tag</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>, ymax <span class="op">=</span> <span class="va">q975.exp_attr</span><span class="op">)</span>, </span>
<span>  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Attributable mortality due to ILI in Norway according to 2 models"</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Aggregated county model: Attributable mortality modeled on a county level before beeing aggregated up to a national level.\n National model: Attributable mortality modeled on a national level."</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-15-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="comparing-cumulative-sums-over-seasons">Comparing cumulative sums over seasons<a class="anchor" aria-label="anchor" href="#comparing-cumulative-sums-over-seasons"></a>
</h2>
<p>When operating on the national level, we prefer to aggregate the county model to national level (instead of using the national model). This ensures consistent results at all geographical levels.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">seasonweek</span>, <span class="va">isoweek</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">/</span><span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, seasonweek, isoweek, attr, sim_id&gt;</span></span>
<span><span class="co">#&gt;       season seasonweek isoweek                       attr sim_id</span></span>
<span><span class="co">#&gt;       &lt;char&gt;      &lt;num&gt;   &lt;int&gt;                     &lt;fctr&gt;  &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010          1      30 sim_value_heatwavedays_n=0      1</span></span>
<span><span class="co">#&gt; 2: 2009/2010          1      30 sim_value_heatwavedays_n=0      2</span></span>
<span><span class="co">#&gt; 3: 2009/2010          1      30 sim_value_heatwavedays_n=0      3</span></span>
<span><span class="co">#&gt; 4: 2009/2010          1      30 sim_value_heatwavedays_n=0      4</span></span>
<span><span class="co">#&gt; 5: 2009/2010          1      30 sim_value_heatwavedays_n=0      5</span></span>
<span><span class="co">#&gt;    sim_value_exposures=observed    value deaths_n exp_attr  exp_irr</span></span>
<span><span class="co">#&gt;                           &lt;num&gt;    &lt;num&gt;    &lt;int&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                     787.5293 748.2371      827 39.29225 1.052513</span></span>
<span><span class="co">#&gt; 2:                     783.5167 747.8438      827 35.67298 1.047701</span></span>
<span><span class="co">#&gt; 3:                     798.1678 760.6366      827 37.53121 1.049342</span></span>
<span><span class="co">#&gt; 4:                     795.4070 757.3645      827 38.04250 1.050230</span></span>
<span><span class="co">#&gt; 5:                     795.7095 756.3119      827 39.39753 1.052092</span></span></code></pre></div>
<p>Again we compute the quantiles.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>,<span class="st">"sim_id"</span>, <span class="st">"exposures"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"value"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation</span><span class="op">[</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,</span>
<span>                                               <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span></span>
<span>              <span class="op">)</span><span class="op">)</span>, </span>
<span>              by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We then estimate the cumulative sums of attributable mortality and corresponding credible intervals.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">median.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">q025.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">q975.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_weekly</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, seasonweek, isoweek, attr, deaths_n&gt;</span></span>
<span><span class="co">#&gt;       season seasonweek isoweek                                  attr deaths_n</span></span>
<span><span class="co">#&gt;       &lt;char&gt;      &lt;num&gt;   &lt;int&gt;                                &lt;fctr&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010          1      30            sim_value_heatwavedays_n=0      827</span></span>
<span><span class="co">#&gt; 2: 2009/2010          1      30 sim_value_ili_isoweekmean7_13_pr100=0      827</span></span>
<span><span class="co">#&gt; 3: 2009/2010          2      31            sim_value_heatwavedays_n=0      751</span></span>
<span><span class="co">#&gt; 4: 2009/2010          2      31 sim_value_ili_isoweekmean7_13_pr100=0      751</span></span>
<span><span class="co">#&gt; 5: 2009/2010          3      32            sim_value_heatwavedays_n=0      811</span></span>
<span><span class="co">#&gt;    median.exp_attr median.exp_irr q025.exp_attr q025.exp_irr q975.exp_attr</span></span>
<span><span class="co">#&gt;              &lt;num&gt;          &lt;num&gt;         &lt;num&gt;        &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    3.846574e+01       1.050819  3.574844e+01     1.047612  4.126351e+01</span></span>
<span><span class="co">#&gt; 2:    0.000000e+00       1.000000  0.000000e+00     1.000000  0.000000e+00</span></span>
<span><span class="co">#&gt; 3:    2.631811e+01       1.034705  2.452781e+01     1.032604  2.813141e+01</span></span>
<span><span class="co">#&gt; 4:    1.796635e-05       1.000000  1.435283e-05     1.000000  2.288203e-05</span></span>
<span><span class="co">#&gt; 5:    2.151458e+01       1.028290  2.005108e+01     1.026579  2.306479e+01</span></span>
<span><span class="co">#&gt;    q975.exp_irr       cumsum  cumsum_q025  cumsum_q975</span></span>
<span><span class="co">#&gt;           &lt;num&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1.054446 3.846574e+01 3.574844e+01 4.126351e+01</span></span>
<span><span class="co">#&gt; 2:     1.000000 0.000000e+00 0.000000e+00 0.000000e+00</span></span>
<span><span class="co">#&gt; 3:     1.037065 6.478385e+01 6.027625e+01 6.939492e+01</span></span>
<span><span class="co">#&gt; 4:     1.000000 1.796635e-05 1.435283e-05 2.288203e-05</span></span>
<span><span class="co">#&gt; 5:     1.030315 8.629843e+01 8.032733e+01 9.245971e+01</span></span></code></pre></div>
<p>We can then plot the estimated cumulative attributable mortality over influenza seasons in Norway</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"2015/2016"</span>,</span>
<span>      <span class="st">"2016/2017"</span>,</span>
<span>      <span class="st">"2017/2018"</span>,</span>
<span>      <span class="st">"2018/2019"</span>,</span>
<span>      <span class="st">"2019/2020"</span></span>
<span>    <span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>, </span>
<span>    y <span class="op">=</span> <span class="va">cumsum</span>, </span>
<span>    group <span class="op">=</span> <span class="va">season</span>, </span>
<span>    color <span class="op">=</span> <span class="va">season</span>, </span>
<span>    fill <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2019/2020"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    ymin <span class="op">=</span> <span class="va">cumsum_q025</span>, </span>
<span>    ymax <span class="op">=</span> <span class="va">cumsum_q975</span></span>
<span>  <span class="op">)</span>, </span>
<span>  alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>  colour <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality over influenza seasons in Norway"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-19-1.png" width="576"></p>
<p>We can also plot the estimated weekly attributable mortality in Norway</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">seasonweek</span>, y <span class="op">=</span> <span class="va">cumsum</span>, group <span class="op">=</span> <span class="va">season</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">!=</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>, </span>
<span>    y <span class="op">=</span> <span class="va">median.exp_attr</span>, </span>
<span>    group <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span>, </span>
<span>  color <span class="op">=</span> <span class="st">"grey"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>,</span>
<span>    y <span class="op">=</span> <span class="va">median.exp_attr</span>,</span>
<span>    group <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span>, </span>
<span>  color <span class="op">=</span> <span class="st">"blue"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">q975.exp_attr</span></span>
<span>  <span class="op">)</span>,</span>
<span>  fill <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>  alpha<span class="op">=</span><span class="fl">0.4</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated mortality due to ILI per week"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="incident-rate-ratio">Incident rate ratio<a class="anchor" aria-label="anchor" href="#incident-rate-ratio"></a>
</h2>
<p>Until now we have focused on estimating attributable mortality. Now we will investigate computing the incident rate ratio (IRR) for <em>ili_isoweekmean7_13_pr100</em>. To do this we will use the fit made by <code>fit_attrib</code> on the county dataset but we will change the values for <em>ili_isoweekmean7_13_pr100</em> to 1 (IRRs are generally expressed as the effect of the exposure changing from 0 to 1).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_fake_county_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">data_fake_county</span><span class="op">)</span></span>
<span><span class="va">data_fake_county_irr</span><span class="op">[</span>, <span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_fake_county_irr</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;location_code, isoweek&gt;</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                     &lt;num&gt;          &lt;num&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:                0.9231202                         1              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                         1              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                         1              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                         1              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                         1              0      115</span></span></code></pre></div>
<p>Then we can set the reference value to zero and hence obtain the IRR for the given exposure.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposures_irr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ili_isoweekmean7_13_pr100 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Now we use <code>est_attrib</code> to create the simulations.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_sim_county_irr</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_county</span>, </span>
<span>  <span class="va">data_fake_county_irr</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures_irr</span>,</span>
<span>  n_sim <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county_irr</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt;           &lt;char&gt;   &lt;int&gt;   &lt;int&gt;      &lt;char&gt;    &lt;char&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                     &lt;num&gt;          &lt;num&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:                0.9231202                         1              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                         1              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                         1              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                         1              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                         1              0      115</span></span>
<span><span class="co">#&gt;       id sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt;    &lt;int&gt;  &lt;num&gt;                        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     1      1                     117.4688</span></span>
<span><span class="co">#&gt; 2:     2      1                     117.3282</span></span>
<span><span class="co">#&gt; 3:     3      1                     117.2330</span></span>
<span><span class="co">#&gt; 4:     4      1                     116.6627</span></span>
<span><span class="co">#&gt; 5:     5      1                     116.4085</span></span>
<span><span class="co">#&gt;    sim_value_ili_isoweekmean7_13_pr100=0</span></span>
<span><span class="co">#&gt;                                    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                              113.7271</span></span>
<span><span class="co">#&gt; 2:                              113.7429</span></span>
<span><span class="co">#&gt; 3:                              113.3460</span></span>
<span><span class="co">#&gt; 4:                              113.1833</span></span>
<span><span class="co">#&gt; 5:                              112.1136</span></span></code></pre></div>
<p>We see we have obtained values for the reference of the exposure in the same way as before. The difference is that we changed the dataset before running <em>est_attrib</em>. This means we will now be observing the difference between <code>ili_isoweekmean7_13_pr100=0</code> and <code>ili_isoweekmean7_13_pr100=1</code>.</p>
<p>We now aggregate to the national seasonal level.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_sim_irr</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_sim_county_irr</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_ili_isoweekmean7_13_pr100=0`</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Here we generate the IRR:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">/</span><span class="va">`sim_value_ili_isoweekmean7_13_pr100=0`</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;season, sim_id&gt;</span></span>
<span><span class="co">#&gt;       season sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt;       &lt;char&gt;  &lt;num&gt;                        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2009/2010      1                     45433.83</span></span>
<span><span class="co">#&gt; 2: 2009/2010      2                     45038.60</span></span>
<span><span class="co">#&gt; 3: 2009/2010      3                     45061.14</span></span>
<span><span class="co">#&gt; 4: 2009/2010      4                     44629.15</span></span>
<span><span class="co">#&gt; 5: 2009/2010      5                     44835.10</span></span>
<span><span class="co">#&gt;    sim_value_ili_isoweekmean7_13_pr100=0 deaths_n  exp_irr</span></span>
<span><span class="co">#&gt;                                    &lt;num&gt;    &lt;int&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                              43986.62    44006 1.032901</span></span>
<span><span class="co">#&gt; 2:                              43429.41    44006 1.037053</span></span>
<span><span class="co">#&gt; 3:                              43557.31    44006 1.034525</span></span>
<span><span class="co">#&gt; 4:                              43267.07    44006 1.031481</span></span>
<span><span class="co">#&gt; 5:                              43528.75    44006 1.030011</span></span></code></pre></div>
<p>Now we can compute the quantiles:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span></span>
<span>  <span class="va">aggregated_county_to_nation_sim_irr</span>,</span>
<span>  <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span>, <span class="st">"sim_id"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_irr</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_irr</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_irr</span></span>
<span><span class="co">#&gt; Key: &lt;season, deaths_n&gt;</span></span>
<span><span class="co">#&gt;        season deaths_n median.exp_irr q025.exp_irr q975.exp_irr        tag</span></span>
<span><span class="co">#&gt;        &lt;char&gt;    &lt;int&gt;          &lt;num&gt;        &lt;num&gt;        &lt;num&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: 2009/2010    44006       1.034507     1.026747     1.041753 aggregated</span></span>
<span><span class="co">#&gt;  2: 2010/2011    43316       1.033126     1.025376     1.040362 aggregated</span></span>
<span><span class="co">#&gt;  3: 2011/2012    43221       1.035902     1.028131     1.043157 aggregated</span></span>
<span><span class="co">#&gt;  4: 2012/2013    43020       1.032344     1.024600     1.039575 aggregated</span></span>
<span><span class="co">#&gt;  5: 2013/2014    43309       1.039923     1.032122     1.047206 aggregated</span></span>
<span><span class="co">#&gt;  6: 2014/2015    43234       1.032436     1.024692     1.039667 aggregated</span></span>
<span><span class="co">#&gt;  7: 2015/2016    44320       1.038390     1.030601     1.045663 aggregated</span></span>
<span><span class="co">#&gt;  8: 2016/2017    43468       1.032826     1.025078     1.040060 aggregated</span></span>
<span><span class="co">#&gt;  9: 2017/2018    43438       1.039085     1.031290     1.046363 aggregated</span></span>
<span><span class="co">#&gt; 10: 2018/2019    43350       1.030587     1.022856     1.037805 aggregated</span></span>
<span><span class="co">#&gt; 11: 2019/2020    43707       1.036065     1.028293     1.043321 aggregated</span></span></code></pre></div>
<p>Now we compare the resulting values for IRR with the ones obtained by <code>coef(fit_county)$season</code> and the 90 percent credible interval computed manually using the standard deviation given by summary(fit_county) for <em>ili_isoweekmean7_13_pr100</em>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coef_fit_county</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_county</span><span class="op">)</span><span class="op">$</span><span class="va">season</span><span class="op">)</span></span>
<span><span class="va">col_names_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ili_isoweekmean7_13_pr100"</span><span class="op">)</span></span>
<span><span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="va">coef_fit_county</span><span class="op">[</span>, <span class="va">..col_names_coef</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">irr</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span>  <span class="co"># 0.003761 is the standard deviation from coef(fit_county)</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"from_coef"</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span></span>
<span><span class="co">#&gt;     ili_isoweekmean7_13_pr100      irr     q025     q975       tag</span></span>
<span><span class="co">#&gt;                         &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1:                0.03380058 1.034378 1.026781 1.042031 from_coef</span></span>
<span><span class="co">#&gt;  2:                0.03246428 1.032997 1.025410 1.040640 from_coef</span></span>
<span><span class="co">#&gt;  3:                0.03514758 1.035773 1.028165 1.043436 from_coef</span></span>
<span><span class="co">#&gt;  4:                0.03170741 1.032215 1.024634 1.039853 from_coef</span></span>
<span><span class="co">#&gt;  5:                0.03902179 1.039793 1.032156 1.047486 from_coef</span></span>
<span><span class="co">#&gt;  6:                0.03179639 1.032307 1.024726 1.039945 from_coef</span></span>
<span><span class="co">#&gt;  7:                0.03754658 1.038260 1.030635 1.045942 from_coef</span></span>
<span><span class="co">#&gt;  8:                0.03217363 1.032697 1.025112 1.040338 from_coef</span></span>
<span><span class="co">#&gt;  9:                0.03821557 1.038955 1.031325 1.046642 from_coef</span></span>
<span><span class="co">#&gt; 10:                0.03000347 1.030458 1.022890 1.038082 from_coef</span></span>
<span><span class="co">#&gt; 11:                0.03530485 1.035935 1.028327 1.043600 from_coef</span></span></code></pre></div>
<p>Add the correct seasons to the data.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>season <span class="op">=</span> <span class="va">aggregated_county_to_nation_irr</span><span class="op">$</span><span class="va">season</span>, <span class="va">coef_irr_data</span><span class="op">)</span></span>
<span><span class="va">coef_irr_data</span></span>
<span><span class="co">#&gt;        season ili_isoweekmean7_13_pr100      irr     q025     q975       tag</span></span>
<span><span class="co">#&gt;        &lt;char&gt;                     &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: 2009/2010                0.03380058 1.034378 1.026781 1.042031 from_coef</span></span>
<span><span class="co">#&gt;  2: 2010/2011                0.03246428 1.032997 1.025410 1.040640 from_coef</span></span>
<span><span class="co">#&gt;  3: 2011/2012                0.03514758 1.035773 1.028165 1.043436 from_coef</span></span>
<span><span class="co">#&gt;  4: 2012/2013                0.03170741 1.032215 1.024634 1.039853 from_coef</span></span>
<span><span class="co">#&gt;  5: 2013/2014                0.03902179 1.039793 1.032156 1.047486 from_coef</span></span>
<span><span class="co">#&gt;  6: 2014/2015                0.03179639 1.032307 1.024726 1.039945 from_coef</span></span>
<span><span class="co">#&gt;  7: 2015/2016                0.03754658 1.038260 1.030635 1.045942 from_coef</span></span>
<span><span class="co">#&gt;  8: 2016/2017                0.03217363 1.032697 1.025112 1.040338 from_coef</span></span>
<span><span class="co">#&gt;  9: 2017/2018                0.03821557 1.038955 1.031325 1.046642 from_coef</span></span>
<span><span class="co">#&gt; 10: 2018/2019                0.03000347 1.030458 1.022890 1.038082 from_coef</span></span>
<span><span class="co">#&gt; 11: 2019/2020                0.03530485 1.035935 1.028327 1.043600 from_coef</span></span></code></pre></div>
<p>rbindlist the two datasets together.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_data_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">coef_irr_data</span>, <span class="va">aggregated_county_to_nation_irr</span><span class="op">)</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">total_data_irr</span><span class="op">[</span>, <span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span><span class="va">total_data_irr</span></span>
<span><span class="co">#&gt;        season      irr     q025     q975        tag</span></span>
<span><span class="co">#&gt;        &lt;char&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;char&gt;</span></span>
<span><span class="co">#&gt;  1: 2009/2010 1.034378 1.026781 1.042031  from_coef</span></span>
<span><span class="co">#&gt;  2: 2010/2011 1.032997 1.025410 1.040640  from_coef</span></span>
<span><span class="co">#&gt;  3: 2011/2012 1.035773 1.028165 1.043436  from_coef</span></span>
<span><span class="co">#&gt;  4: 2012/2013 1.032215 1.024634 1.039853  from_coef</span></span>
<span><span class="co">#&gt;  5: 2013/2014 1.039793 1.032156 1.047486  from_coef</span></span>
<span><span class="co">#&gt;  6: 2014/2015 1.032307 1.024726 1.039945  from_coef</span></span>
<span><span class="co">#&gt;  7: 2015/2016 1.038260 1.030635 1.045942  from_coef</span></span>
<span><span class="co">#&gt;  8: 2016/2017 1.032697 1.025112 1.040338  from_coef</span></span>
<span><span class="co">#&gt;  9: 2017/2018 1.038955 1.031325 1.046642  from_coef</span></span>
<span><span class="co">#&gt; 10: 2018/2019 1.030458 1.022890 1.038082  from_coef</span></span>
<span><span class="co">#&gt; 11: 2019/2020 1.035935 1.028327 1.043600  from_coef</span></span>
<span><span class="co">#&gt; 12: 2009/2010 1.034507 1.026747 1.041753 aggregated</span></span>
<span><span class="co">#&gt; 13: 2010/2011 1.033126 1.025376 1.040362 aggregated</span></span>
<span><span class="co">#&gt; 14: 2011/2012 1.035902 1.028131 1.043157 aggregated</span></span>
<span><span class="co">#&gt; 15: 2012/2013 1.032344 1.024600 1.039575 aggregated</span></span>
<span><span class="co">#&gt; 16: 2013/2014 1.039923 1.032122 1.047206 aggregated</span></span>
<span><span class="co">#&gt; 17: 2014/2015 1.032436 1.024692 1.039667 aggregated</span></span>
<span><span class="co">#&gt; 18: 2015/2016 1.038390 1.030601 1.045663 aggregated</span></span>
<span><span class="co">#&gt; 19: 2016/2017 1.032826 1.025078 1.040060 aggregated</span></span>
<span><span class="co">#&gt; 20: 2017/2018 1.039085 1.031290 1.046363 aggregated</span></span>
<span><span class="co">#&gt; 21: 2018/2019 1.030587 1.022856 1.037805 aggregated</span></span>
<span><span class="co">#&gt; 22: 2019/2020 1.036065 1.028293 1.043321 aggregated</span></span>
<span><span class="co">#&gt;        season      irr     q025     q975        tag</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">total_data_irr</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">season</span>,</span>
<span>    group <span class="op">=</span> <span class="va">tag</span>, </span>
<span>    color <span class="op">=</span> <span class="va">tag</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">irr</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">q025</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">q975</span></span>
<span>  <span class="op">)</span>,</span>
<span>  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Incident risk ratio"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Incident risk ratio for ILI per season"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-30-1.png" width="576"></p>
<p>As we can see these intervals are very similar.</p>
<p>The benefit of the simulated approach is that this process will be equally easy no matter the complexity of what we want to compute the IRR for. We do not have to take into account the variance-covariance matrix at any stage.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://www.csids.no" class="external-link"><img src="https://www.csids.no/resources/logo/logo_full_blue.svg" width="200"></a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Crafted by <a href="https://www.rwhite.no" class="external-link">Richard Aubrey White</a>, Aurora Christine Hofman.</p>
</div>

    </footer>
</div>





  </body>
</html>
